// WS handler
\c 120 25;
deny: ("\\\\\\\\";"exit";"top";"kill";"spawn";"set";"load";"show";"getenv";"setenv";"argv";"system";"eval");
peval: {[expr]
    e: ,/ss[expr;]'deny;
    $[0=#e;eval parse expr;'"Operation is not permitted in a web REPL mode"]
};
ps1: {println["Welcome to ThePlatform v1.0.0\n(Web REPL - strict mode)\n-----------------------------"]};
.webrepl.run: {
    spawn {
        ws: reagent[`listener;"0.0.0.0:45101"];
        sw: reagent[`state;ws];
        react {[x:sw] println["ws listener has been disconnected: %";x]};
        react[{[x:ws]
            spawn[{[sock]
                h: reagent[`ws;sock];
                s: reagent[`state;h];
                react {[x:s] .o.out:: 0N; .o.err:: 0N; println["ws client has been disconnected: %";x]};
                // redirect stdout/stderr
                .o.out:: h; .o.err:: h;
                react[{[x:h]
                    cli: h;
                    r: @[peval;"c"$x;{println["** % error: `%`\n%";x`kind;x`call;x`message]}];
                    if [~0N0~r] { cli[repr r] }
                }]
            };x]
        }]
    }
};
